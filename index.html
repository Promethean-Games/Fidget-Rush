<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fidget Rush - Keep Your Hands Busy!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Arial Black', Arial, sans-serif;
            background: radial-gradient(circle at top, #1e293b 0%, #020617 45%, #000000 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100vh;
            padding: 20px;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes bounceHorizontal {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-15px); }
            75% { transform: translateX(15px); }
        }

        @keyframes flipHorizontal {
            0%, 100% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
        }

        h1 {
            font-size: clamp(2em, 8vw, 3em);
            text-shadow: 4px 4px 0px rgba(0,0,0,0.6);
            margin-bottom: 20px;
            background: linear-gradient(45deg, #FF6B6B, #FFD93D, #6BCF7F, #4ECDC4, #FF6B6B);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 3s ease infinite, pulse 2s ease-in-out infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .btn {
            background: radial-gradient(circle at top left, #FF8E53, #FF6B6B);
            border: 4px solid rgba(255,255,255,0.9);
            color: white;
            font-size: clamp(1.2em, 4vw, 1.5em);
            font-weight: bold;
            padding: 20px 40px;
            border-radius: 999px;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 10px 25px rgba(0,0,0,0.6);
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.3s ease;
            margin: 10px;
            letter-spacing: 0.08em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 30px rgba(0,0,0,0.8);
        }

        .btn:active {
            transform: translateY(3px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.6);
        }

        .tutorial-step-container {
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tutorial-step {
            background: radial-gradient(circle at top, rgba(255,255,255,0.14), rgba(15,23,42,0.9));
            border: 4px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 30px 20px;
            width: 100%;
            backdrop-filter: blur(16px);
            text-align: center;
            box-shadow: 0 18px 40px rgba(0,0,0,0.85);
        }

        .tutorial-step h2 {
            font-size: clamp(1.3em, 5vw, 2em);
            margin: 15px 0 10px;
        }

        .tutorial-step p {
            font-size: clamp(0.95em, 3vw, 1.2em);
            line-height: 1.6;
            opacity: 0.95;
            margin: 15px 0;
        }

        .tutorial-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }

        .tutorial-nav .btn {
            font-size: clamp(0.9em, 3vw, 1.1em);
            padding: 15px 25px;
            margin: 5px;
        }

        .settings-menu {
            width: 90%;
            max-width: 500px;
            background: radial-gradient(circle at top, rgba(255,255,255,0.12), rgba(15,23,42,0.92));
            border: 4px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 20px;
            backdrop-filter: blur(18px);
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 18px 40px rgba(0,0,0,0.85);
        }

        .settings-section {
            margin: 20px 0;
        }

        .settings-label {
            font-size: clamp(1em, 3.5vw, 1.3em);
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 0.08em;
            opacity: 0.9;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .theme-option {
            padding: 15px;
            border: 3px solid rgba(255,255,255,0.9);
            border-radius: 18px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: clamp(0.9em, 3vw, 1.1em);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease, filter 0.25s ease, opacity 0.25s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.75);
            position: relative;
        }

        .theme-option:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 12px 26px rgba(0,0,0,0.9);
        }

        .theme-option.active {
            box-shadow: 0 0 24px rgba(250,250,250,0.8);
            transform: translateY(-1px) scale(1.05);
            border-color: #FFD93D;
        }

        .theme-option.locked {
            opacity: 0.3;
            filter: grayscale(0.7);
            cursor: not-allowed;
        }

        .theme-option.locked::after {
            content: "üîí";
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 1.2em;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
        }

        .top-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .control-icon {
            font-size: 1.8em;
            cursor: pointer;
            background: rgba(15,23,42,0.85);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(255,255,255,0.9);
            box-shadow: 0 10px 25px rgba(0,0,0,0.85);
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.25s ease;
        }

        .control-icon:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(0,0,0,0.9);
        }

        .control-icon:active {
            background: rgba(30,64,175,0.9);
            transform: translateY(2px);
            box-shadow: 0 6px 14px rgba(0,0,0,0.8);
        }

        .game-container {
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        .score-display {
            font-size: clamp(2em, 7vw, 3em);
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.6);
        }

        .timer-bar {
            width: 100%;
            height: 40px;
            background: rgba(15,23,42,0.95);
            border: 4px solid rgba(255,255,255,0.9);
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: 0 10px 24px rgba(0,0,0,0.8);
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #6BCF7F, #FFD93D, #FF6B6B);
            transition: width 0.1s linear;
            border-radius: 15px;
        }

        .action-display {
            background: radial-gradient(circle at top, #1e293b, #020617);
            border: 5px solid rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 30px 20px;
            margin: 30px 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            transition: background 0.3s ease, transform 0.25s ease;
        }

        .action-display:hover {
            transform: translateY(-2px);
        }

        .action-icon {
            font-size: clamp(5em, 20vw, 8em);
            margin: 15px 0;
            text-shadow: 0 10px 24px rgba(0,0,0,0.9);
        }

        .action-icon.shake-animation {
            animation: bounceHorizontal 0.8s infinite;
        }

        .action-icon.spin-animation {
            animation: flipHorizontal 1.5s infinite;
        }

        .action-icon.default-animation {
            animation: bounce 1s infinite;
        }

        .action-icon.pulse {
            animation: pulse 1.5s infinite;
        }

        .action-text {
            font-size: clamp(2em, 8vw, 3.5em);
            font-weight: bold;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.7);
            text-align: center;
            word-wrap: break-word;
        }

        .game-over-screen {
            text-align: center;
            padding: 5px;
            max-height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .game-over-title {
            font-size: clamp(1.8em, 7vw, 3em);
            font-weight: bold;
            margin: 5px 0 3px 0;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.6);
            background: linear-gradient(45deg, #FF6B6B, #FFD93D);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradient 2s ease infinite;
        }

        .summary-header {
            font-size: clamp(1em, 3.5vw, 1.5em);
            font-weight: bold;
            margin: 3px 0;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.6);
        }

        .summary-stats {
            background: rgba(15,23,42,0.9);
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: clamp(5px, 2vw, 8px);
            margin: 3px auto;
            backdrop-filter: blur(10px);
            max-width: 95%;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 14px 30px rgba(0,0,0,0.9);
        }

        .stat-row {
            background: linear-gradient(135deg, #4ECDC4, #556ECF);
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: clamp(5px, 1.5vw, 8px);
            margin: 3px 0;
            font-size: clamp(0.7em, 2.5vw, 0.9em);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            word-break: break-word;
            box-sizing: border-box;
        }
        
        .stat-row span {
            flex-shrink: 1;
            min-width: 0;
        }

        .highscore-list {
            background: rgba(15,23,42,0.9);
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: clamp(5px, 2vw, 8px);
            margin: 3px auto;
            backdrop-filter: blur(10px);
            max-width: 95%;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 14px 30px rgba(0,0,0,0.9);
        }

        .highscore-list h2 {
            font-size: clamp(1em, 3.5vw, 1.4em);
            margin: 3px 0 5px 0;
        }

        .highscore-item {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border: 2px solid rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: clamp(5px, 1.5vw, 7px) clamp(8px, 2vw, 10px);
            margin: 3px 0;
            font-size: clamp(0.7em, 2.5vw, 0.9em);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            box-sizing: border-box;
            text-shadow: 0 2px 4px rgba(0,0,0,0.7);
        }

        .highscore-item.first {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            font-size: clamp(0.75em, 2.8vw, 1em);
            animation: pulse 2s infinite;
        }

        .initials-input {
            font-size: clamp(1em, 3.5vw, 1.3em);
            padding: 8px;
            border: 2px solid rgba(255,255,255,0.9);
            border-radius: 10px;
            text-align: center;
            text-transform: uppercase;
            max-width: 120px;
            margin: 5px auto;
            font-weight: bold;
            background: rgba(255,255,255,0.9);
            color: #111827;
        }

        #newHighScoreSection h2 {
            font-size: clamp(1em, 3.5vw, 1.4em);
            margin: 5px 0;
        }

        .share-btn {
            background: linear-gradient(135deg, #6BCF7F, #4ECDC4);
            border: 2px solid rgba(255,255,255,0.9);
            color: white;
            font-size: clamp(0.8em, 3vw, 1em);
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            margin: 4px 3px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.75);
        }

        .countdown {
            font-size: clamp(4em, 15vw, 5em);
            font-weight: bold;
            animation: pulse 0.5s ease-in-out;
            text-shadow: 0 8px 24px rgba(0,0,0,0.9);
        }

        .success-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            animation: successPop 0.5s ease-out;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        .subtitle {
            font-size: clamp(1em, 3vw, 1.2em);
            margin: 10px 0;
            opacity: 0.9;
        }

        .swipe-hint {
            font-size: clamp(0.8em, 2.5vw, 0.9em);
            opacity: 0.75;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div id="welcomeScreen" class="screen active">
        <h1>FIDGET RUSH</h1>
        <p class="subtitle">Keep Your Hands Busy!</p>
        <button class="btn" onclick="handleStartButton()">START</button>
        <div style="margin-top: 15px; opacity: 0.7; font-size: clamp(0.85em, 2.5vw, 1em);">
            <a href="#" onclick="event.preventDefault(); showTutorial();" style="color: white; text-decoration: underline;">How to Play</a>
        </div>
    </div>

    <div id="tutorialScreen" class="screen">
        <h1>LEARN THE MOVES</h1>
        <div class="tutorial-step-container">
            <div class="tutorial-step" id="tutorialStep">
                <div class="action-icon" id="tutorialIcon">üéÆ</div>
                <h2 id="tutorialGestureName">GESTURE NAME</h2>
                <p id="tutorialDescription">Description goes here</p>
                <div id="tutorialStatus" style="font-size: clamp(1.5em, 5vw, 2em); margin: 20px 0;">‚è∏Ô∏è</div>
            </div>
            <div class="tutorial-nav">
                <button class="btn" id="prevBtn" onclick="previousTutorialStep()" style="opacity: 0.6;">‚óÑ BACK</button>
                <div style="margin: 0 15px; font-size: clamp(0.9em, 3vw, 1.1em); opacity: 0.8;">
                    <span id="tutorialProgress">1/5</span>
                </div>
                <button class="btn" id="nextBtn" onclick="nextTutorialStep()">NEXT ‚ñ∫</button>
            </div>
        </div>
        <button class="btn" id="finishTutorialBtn" onclick="completeTutorial()" style="margin-top: 20px; display: none;">START PLAYING!</button>
    </div>

    <div id="settingsScreen" class="screen">
        <h1>SETTINGS</h1>
        <div class="settings-menu">
            <div class="settings-section">
                <div class="settings-label">üé® CHOOSE THEME</div>
                <div class="theme-grid" id="themeGrid"></div>
            </div>
            <div class="settings-section">
                <div class="settings-label">üìö TUTORIAL</div>
                <button class="btn" onclick="showTutorial()">VIEW TUTORIAL</button>
            </div>
        </div>
        <button class="btn" onclick="closeSettings()">BACK</button>
    </div>

    <div id="gameScreen" class="screen">
        <div class="top-controls">
            <div class="control-icon" id="pausePlayBtn" onclick="togglePause()">‚è∏Ô∏è</div>
            <div class="control-icon" onclick="openSettings()">‚öôÔ∏è</div>
        </div>
        <div class="game-container">
            <div class="score-display">SCORE: <span id="currentScore">0</span></div>
            <div class="timer-bar">
                <div class="timer-fill" id="timerFill"></div>
            </div>
            <div class="action-display">
                <div class="action-icon" id="actionIcon">üéÆ</div>
                <div class="action-text" id="actionText">GET READY!</div>
            </div>
            <div id="readyTutorialLink" class="swipe-hint" style="display: none;">
                <a href="#" onclick="event.preventDefault(); showTutorial();" style="color: white; text-decoration: underline;">How to Play</a>
            </div>
        </div>
    </div>

    <div id="summaryScreen" class="screen">
        <div class="game-over-screen">
            <div class="game-over-title">GAME OVER</div>
            <div class="summary-header">GAME SUMMARY</div>
            <div class="summary-stats" id="summaryStats">
                <div class="stat-row">
                    <span>FINAL SCORE:</span>
                    <span id="finalScore">0</span>
                </div>
                <div class="stat-row">
                    <span>FASTEST MOVE:</span>
                    <span id="fastestMove">-</span>
                </div>
                <div class="stat-row">
                    <span>SLOWEST MOVE:</span>
                    <span id="slowestMove">-</span>
                </div>
            </div>
            <div id="newHighScoreSection" style="display: none;">
                <h2 style="color: #FFD700; text-shadow: 2px 2px 0 rgba(0,0,0,0.6);">NEW HIGH SCORE!</h2>
                <input type="text" id="initialsInput" class="initials-input" maxlength="3" placeholder="AAA">
                <button class="btn" onclick="saveHighScore()">SAVE</button>
            </div>
            <div class="highscore-list" id="highScoreList">
                <h2>HIGH SCORES</h2>
            </div>
            <button class="share-btn" onclick="shareScore()">üì± SHARE SCORE</button>
            <button class="btn" onclick="restartGame()">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        let score = 0;
        let currentGesture = null;
        let gameActive = false;
        let gamePaused = false;
        let tutorialMode = false;
        let currentTutorialStep = 0;
        let timeLimit = 3000;
        let timerInterval = null;
        let moveTimes = [];
        let moveHistory = [];
        let moveStartTime = 0;
        let currentTheme = 'dark';
        let returnScreen = 'welcomeScreen';

        const themes = {
            default: {
                name: 'Default',
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white'
            },
            dark: {
                name: 'Dark',
                background: 'linear-gradient(135deg, #0f172a 0%, #020617 100%)',
                color: 'white'
            },
            sunset: {
                name: 'Sunset',
                background: 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%)',
                color: 'white'
            },
            ocean: {
                name: 'Ocean',
                background: 'linear-gradient(135deg, #0093e9 0%, #80d0c7 100%)',
                color: 'white'
            },
            forest: {
                name: 'Forest',
                background: 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)',
                color: 'white'
            },
            neon: {
                name: 'Neon',
                background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                color: 'white'
            }
        };

        const themeOrder = ['dark', 'default', 'sunset', 'ocean', 'forest', 'neon'];

        const gestures = [
            { name: 'STRIKE A POSE', icon: 'ü§≥', type: 'tilt', description: 'Lift phone up and tilt down like taking a selfie', color: '#9333ea' },
            { name: 'SHAKE IT', icon: 'üì≥', type: 'shake', description: 'Shake your phone vigorously left and right like a foam finger', color: '#dc2626' },
            { name: 'SPIN IT', icon: 'üöÅ', type: 'spin', description: 'Rotate your phone 90¬∞ like spinning helicopter blades', color: '#0891b2' },
            { name: 'GO FISH', icon: 'üé£', type: 'fish', description: 'Hold phone sideways and flick forward like casting a fishing rod', color: '#16a34a' },
            { name: 'WAVE IT', icon: 'üëã', type: 'wave', description: 'Wave your phone side-to-side like saying goodbye', color: '#ea580c' }
        ];

        let motionData = {
            lastAccX: 0,
            lastAccY: 0,
            lastAccZ: 0,
            lastShakeDirection: 0,
            shakeDirectionChanges: 0,
            rotation: 0,
            lastRotation: 0,
            lastGamma: 0,
            waveOscillations: 0,
            lastWaveDirection: 0,
            tiltThreshold: 15,
            rotationThreshold: 90,
            tapThreshold: 40,
            waveOscillationsNeeded: 3,
            tiltStartTime: 0,
            tiltHoldDuration: 100,
            lastTapTrigger: 0,
            tapDebounce: 300,
            lastLiftTime: 0,
            lastTiltTime: 0,
            liftThreshold: 9,
            selfieWindow: 800,
            fishCastStartTime: 0,
            fishPeakX: 0,
            fishCastThreshold: 7,
            fishStopWindow: 200,
            awaitingFishStop: false,
            isPhonePerpendicular: false,
            lastFishAccX: 0,
            spinStartTime: 0,
            spinPeakAcceleration: 0,
            spinAccelerationThreshold: 15,
            spinMinTime: 300,
            spinMaxTime: 3000,
            spinDirection: 0,
            spinDirectionChanges: 0,
            spinMaxDirectionChanges: 2,
            spinAttemptActive: false
        };

        let gestureCompleted = new Array(gestures.length).fill(false);

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function loadTheme() {
            const unlocked = getUnlockedThemeSet();
            let saved = localStorage.getItem('fidgetRushTheme');
            if (!saved || !themes[saved] || !unlocked.has(saved)) {
                saved = 'dark';
                localStorage.setItem('fidgetRushTheme', saved);
            }
            currentTheme = saved;
            applyTheme(currentTheme);
        }

        function applyTheme(themeId) {
            const theme = themes[themeId];
            if (!theme) return;
            document.body.style.background = theme.background;
            document.body.style.color = theme.color;
            currentTheme = themeId;
            localStorage.setItem('fidgetRushTheme', themeId);
        }

        function buildThemeGrid() {
            const grid = document.getElementById('themeGrid');
            grid.innerHTML = '';
            const unlocked = getUnlockedThemeSet();
            
            themeOrder.forEach(themeId => {
                const theme = themes[themeId];
                if (!theme) return;

                const option = document.createElement('div');
                let classNames = 'theme-option';
                const isUnlocked = unlocked.has(themeId);
                if (!isUnlocked) {
                    classNames += ' locked';
                }
                if (themeId === currentTheme && isUnlocked) {
                    classNames += ' active';
                }
                option.className = classNames;
                option.style.background = theme.background;
                option.innerHTML = `
                    <div>${theme.name}</div>
                    ${!isUnlocked ? '<div style="margin-top:6px;font-size:0.75em;opacity:0.85;">Score up to unlock</div>' : ''}
                `;
                option.onclick = () => {
                    if (!isUnlocked) {
                        return;
                    }
                    applyTheme(themeId);
                    buildThemeGrid();
                };
                grid.appendChild(option);
            });
        }

        function handleStartButton() {
            const tutorialCompleted = localStorage.getItem('fidgetRushTutorialCompleted') === 'true';
            if (tutorialCompleted) {
                startGame();
            } else {
                showTutorial();
            }
        }

        function showTutorial() {
            gestureCompleted = new Array(gestures.length).fill(false);
            currentTutorialStep = 0;
            showScreen('tutorialScreen');
            updateTutorialStep();
            requestDevicePermissions(true);
        }

        function updateTutorialStep() {
            const gesture = gestures[currentTutorialStep];
            document.getElementById('tutorialIcon').textContent = gesture.icon;
            document.getElementById('tutorialGestureName').textContent = gesture.name;
            document.getElementById('tutorialDescription').textContent = gesture.description;
            document.getElementById('tutorialStatus').textContent = gestureCompleted[currentTutorialStep] ? '‚úÖ' : '‚è∏Ô∏è';
            document.getElementById('tutorialProgress').textContent = `${currentTutorialStep + 1}/${gestures.length}`;
            
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishTutorialBtn');
            
            prevBtn.style.opacity = currentTutorialStep === 0 ? '0.4' : '0.6';
            prevBtn.disabled = currentTutorialStep === 0;
            
            if (currentTutorialStep === gestures.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                finishBtn.style.display = 'none';
            }
        }

        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }

        function nextTutorialStep() {
            if (currentTutorialStep < gestures.length - 1) {
                currentTutorialStep++;
                updateTutorialStep();
            }
        }

        function updateGestureStatus(index, message) {
            if (index === currentTutorialStep) {
                document.getElementById('tutorialStatus').textContent = message;
            }
        }

        function openSettings() {
            const activeScreen = document.querySelector('.screen.active');
            returnScreen = activeScreen ? activeScreen.id : 'welcomeScreen';
            if (returnScreen === 'gameScreen') {
                gamePaused = true;
                clearInterval(timerInterval);
            }
            buildThemeGrid();
            showScreen('settingsScreen');
        }

        function closeSettings() {
            showScreen(returnScreen);
            if (returnScreen === 'gameScreen' && !tutorialMode && gameActive) {
                gamePaused = false;
                startTimer();
            }
        }

        function resetSpinState() {
            motionData.rotation = 0;
            motionData.spinStartTime = 0;
            motionData.spinPeakAcceleration = 0;
            motionData.spinDirection = 0;
            motionData.spinDirectionChanges = 0;
            motionData.spinAttemptActive = false;
        }

        function resetGestureTracking() {
            motionData.rotation = 0;
            motionData.waveOscillations = 0;
            motionData.lastWaveDirection = 0;
            motionData.shakeDirectionChanges = 0;
            motionData.lastShakeDirection = 0;
            motionData.tiltStartTime = 0;
            motionData.lastLiftTime = 0;
            motionData.lastTiltTime = 0;
            motionData.fishCastStartTime = 0;
            motionData.fishPeakX = 0;
            motionData.awaitingFishStop = false;
            motionData.lastFishAccX = 0;
            resetSpinState();
        }

        function completeTutorial() {
            tutorialMode = false;
            removeSensors();
            localStorage.setItem('fidgetRushTutorialCompleted', 'true');
            startGame();
        }

        function togglePause() {
            if (!gameActive) return;
            
            gamePaused = !gamePaused;
            const btn = document.getElementById('pausePlayBtn');
            btn.textContent = gamePaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            
            if (gamePaused) {
                clearInterval(timerInterval);
            } else {
                startTimer();
            }
        }

        function startGame() {
            score = 0;
            moveTimes = [];
            moveHistory = [];
            timeLimit = 3000;
            gameActive = false;
            gamePaused = false;
            tutorialMode = false;
            
            showScreen('gameScreen');
            document.getElementById('currentScore').textContent = score;
            document.getElementById('pausePlayBtn').textContent = '‚è∏Ô∏è';
            
            requestDevicePermissions(false);
        }

        async function requestDevicePermissions(isTutorial) {
            let motionGranted = true;
            let orientationGranted = true;

            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const motionPermission = await DeviceMotionEvent.requestPermission();
                    motionGranted = motionPermission === 'granted';
                } catch (error) {
                    console.error('Motion permission error:', error);
                }
            }

            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const orientationPermission = await DeviceOrientationEvent.requestPermission();
                    orientationGranted = orientationPermission === 'granted';
                } catch (error) {
                    console.error('Orientation permission error:', error);
                }
            }

            if (!motionGranted || !orientationGranted) {
                const deniedSensors = [];
                if (!motionGranted) deniedSensors.push('motion');
                if (!orientationGranted) deniedSensors.push('orientation');
                
                alert(`Please enable ${deniedSensors.join(' and ')} sensors in your device settings to play Fidget Rush!\n\nOn iOS: Settings > Safari > Motion & Orientation Access`);
                showScreen('welcomeScreen');
                return;
            }

            initializeSensors();
            
            if (isTutorial) {
                tutorialMode = true;
            } else {
                showReadyPrompt();
            }
        }

        function showReadyPrompt() {
            const actionIcon = document.getElementById('actionIcon');
            const actionText = document.getElementById('actionText');
            const actionDisplay = document.querySelector('.action-display');
            
            actionIcon.style.display = 'block';
            actionIcon.textContent = 'üëã';
            actionIcon.className = 'action-icon pulse';
            actionText.textContent = 'READY?';
            actionDisplay.style.background = 'radial-gradient(circle at top, #1e293b, #020617)';

            const oldListener = actionDisplay.getAttribute('data-listener-attached');
            if (!oldListener) {
                actionDisplay.setAttribute('data-listener-attached', 'true');
                actionDisplay.addEventListener('click', () => {
                    countdown();
                }, { once: true });
            }
        }

        function initializeSensors() {
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function removeSensors() {
            window.removeEventListener('devicemotion', handleMotion);
            window.removeEventListener('deviceorientation', handleOrientation);
        }

        function handleMotion(event) {
            if (gamePaused) return;
            
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const accX = acc.x || 0;
            const accY = acc.y || 0;
            const accZ = acc.z || 0;

            if (Math.abs(accX) > 5) {
                const currentDirection = accX > 0 ? 1 : -1;
                if (motionData.lastShakeDirection !== 0 && currentDirection !== motionData.lastShakeDirection) {
                    motionData.shakeDirectionChanges++;
                }
                motionData.lastShakeDirection = currentDirection;
            }

            motionData.lastAccX = accX;
            motionData.lastAccY = accY;
            motionData.lastAccZ = accZ;

            const gravityFreeAcc = event.acceleration;
            const totalAcc = gravityFreeAcc 
                ? Math.abs(gravityFreeAcc.x || 0) + Math.abs(gravityFreeAcc.y || 0) + Math.abs(gravityFreeAcc.z || 0)
                : Math.abs(accX) + Math.abs(accY) + Math.abs(accZ);

            const now = Date.now();
            
            if ((tutorialMode || (gameActive && currentGesture && currentGesture.type === 'spin')) && motionData.spinAttemptActive) {
                if (totalAcc > motionData.spinPeakAcceleration) {
                    motionData.spinPeakAcceleration = totalAcc;
                }
                
                if (motionData.spinPeakAcceleration > motionData.spinAccelerationThreshold) {
                    resetSpinState();
                }
            }

            const canTriggerTap = (now - motionData.lastTapTrigger) > motionData.tapDebounce;

            if ((tutorialMode || (gameActive && currentGesture && currentGesture.type === 'tilt'))) {
                if (accY < -motionData.liftThreshold) {
                    motionData.lastLiftTime = now;
                    
                    const timeSinceTilt = now - motionData.lastTiltTime;
                    const hasBothGestures = motionData.lastTiltTime > 0 && timeSinceTilt <= motionData.selfieWindow;
                    
                    if (hasBothGestures) {
                        if (tutorialMode) {
                            motionData.tiltStartTime = 0;
                            motionData.lastLiftTime = 0;
                            motionData.lastTiltTime = 0;
                            handleTutorialSuccess('tilt');
                        } else if (gameActive && currentGesture && currentGesture.type === 'tilt') {
                            motionData.tiltStartTime = 0;
                            motionData.lastLiftTime = 0;
                            motionData.lastTiltTime = 0;
                            completeGesture();
                        }
                    }
                }
            }

            if ((tutorialMode || (gameActive && currentGesture && currentGesture.type === 'fish'))) {
                if (motionData.lastFishAccX === 0) {
                    motionData.lastFishAccX = accX;
                }
                
                const xAccDiff = accX - motionData.lastFishAccX;
                motionData.lastFishAccX = accX;
                
                if (!motionData.awaitingFishStop && Math.abs(xAccDiff) > motionData.fishCastThreshold && motionData.isPhonePerpendicular) {
                    motionData.awaitingFishStop = true;
                    motionData.fishCastStartTime = now;
                    motionData.fishPeakX = xAccDiff;
                } else if (motionData.awaitingFishStop) {
                    const elapsed = now - motionData.fishCastStartTime;
                    const hasStopped = Math.abs(xAccDiff) < 1.5 || (Math.sign(xAccDiff) !== Math.sign(motionData.fishPeakX) && Math.abs(xAccDiff) > 2);
                    
                    if (elapsed > motionData.fishStopWindow) {
                        motionData.awaitingFishStop = false;
                        motionData.fishCastStartTime = 0;
                        motionData.fishPeakX = 0;
                        motionData.lastFishAccX = accX;
                    } else if (hasStopped && elapsed > 50) {
                        if (tutorialMode) {
                            motionData.awaitingFishStop = false;
                            motionData.fishCastStartTime = 0;
                            motionData.fishPeakX = 0;
                            motionData.lastFishAccX = accX;
                            handleTutorialSuccess('fish');
                        } else if (gameActive && currentGesture && currentGesture.type === 'fish') {
                            motionData.awaitingFishStop = false;
                            motionData.fishCastStartTime = 0;
                            motionData.fishPeakX = 0;
                            motionData.lastFishAccX = accX;
                            completeGesture();
                        }
                    }
                }
            }

            if (tutorialMode) {
                if (motionData.shakeDirectionChanges >= 3) {
                    handleTutorialSuccess('shake');
                }
            } else if (gameActive) {
                if (currentGesture && currentGesture.type === 'shake' && motionData.shakeDirectionChanges >= 3) {
                    completeGesture();
                }
            }
        }

        function handleOrientation(event) {
            if (gamePaused) return;
            
            const beta = event.beta;
            const gamma = event.gamma;
            const alpha = event.alpha;

            if (beta !== null && gamma !== null) {
                const isPortrait = Math.abs(gamma) < 45;
                const portraitBaseline = -90;
                const tiltFromBaseline = beta - portraitBaseline;
                const now = Date.now();
                
                motionData.isPhonePerpendicular = Math.abs(Math.abs(gamma) - 90) < 30;

                const isTilted = isPortrait && tiltFromBaseline > motionData.tiltThreshold;

                if ((tutorialMode || (gameActive && currentGesture && currentGesture.type === 'tilt')) && isTilted) {
                    if (motionData.tiltStartTime === 0) {
                        motionData.tiltStartTime = now;
                    } else {
                        const tiltDuration = now - motionData.tiltStartTime;
                        if (tiltDuration >= motionData.tiltHoldDuration) {
                            motionData.lastTiltTime = now;
                            if (tutorialMode) {
                                motionData.tiltStartTime = 0;
                                handleTutorialSuccess('tilt');
                            } else if (gameActive && currentGesture && currentGesture.type === 'tilt') {
                                motionData.tiltStartTime = 0;
                                completeGesture();
                            }
                        }
                    }
                } else {
                    motionData.tiltStartTime = 0;
                }

                let headingChange = 0;
                if (motionData.lastRotation !== null && typeof alpha === 'number') {
                    let diff = alpha - motionData.lastRotation;
                    if (diff > 180) diff -= 360;
                    if (diff < -180) diff += 360;
                    headingChange = diff;
                }
                
                if ((tutorialMode || (gameActive && currentGesture && currentGesture.type === 'spin')) && typeof alpha === 'number') {
                    const nowSpin = now;
                    
                    if (!motionData.spinAttemptActive) {
                        if (Math.abs(headingChange) > 10) {
                            motionData.spinAttemptActive = true;
                            motionData.spinStartTime = nowSpin;
                            motionData.spinPeakAcceleration = 0;
                            motionData.spinDirection = headingChange > 0 ? 1 : -1;
                            motionData.spinDirectionChanges = 0;
                        }
                    } else {
                        if (Math.sign(headingChange) !== motionData.spinDirection && Math.abs(headingChange) > 10) {
                            motionData.spinDirectionChanges++;
                            motionData.spinDirection = Math.sign(headingChange);
                        }
                        
                        const elapsedSpin = nowSpin - motionData.spinStartTime;
                        motionData.rotation += headingChange;

                        const absRotation = Math.abs(motionData.rotation);

                        if (
                            absRotation >= motionData.rotationThreshold &&
                            elapsedSpin >= motionData.spinMinTime &&
                            elapsedSpin <= motionData.spinMaxTime &&
                            motionData.spinDirectionChanges <= motionData.spinMaxDirectionChanges
                        ) {
                            if (tutorialMode) {
                                resetSpinState();
                                handleTutorialSuccess('spin');
                            } else if (gameActive && currentGesture && currentGesture.type === 'spin') {
                                resetSpinState();
                                completeGesture();
                            }
                        } else if (elapsedSpin > motionData.spinMaxTime) {
                            resetSpinState();
                        }
                    }
                }

                motionData.lastRotation = typeof alpha === 'number' ? alpha : motionData.lastRotation;

                const waveDirection = gamma > motionData.lastGamma ? 1 : (gamma < motionData.lastGamma ? -1 : 0);
                if (Math.abs(gamma - motionData.lastGamma) > 5) {
                    if (motionData.lastWaveDirection !== 0 && waveDirection !== 0 && waveDirection !== motionData.lastWaveDirection) {
                        motionData.waveOscillations++;
                    }
                    motionData.lastWaveDirection = waveDirection;
                }
                motionData.lastGamma = gamma;

                if (tutorialMode) {
                    if (motionData.waveOscillations >= motionData.waveOscillationsNeeded) {
                        handleTutorialSuccess('wave');
                    }
                } else if (gameActive) {
                    if (currentGesture && currentGesture.type === 'wave' && motionData.waveOscillations >= motionData.waveOscillationsNeeded) {
                        completeGesture();
                    }
                }
            }
        }

        function getUnlockedThemeSet() {
            const bestScore = getBestScore();
            const unlocked = new Set();
            
            unlocked.add('dark');

            if (bestScore >= 10) unlocked.add('default');
            if (bestScore >= 20) unlocked.add('sunset');
            if (bestScore >= 30) unlocked.add('ocean');
            if (bestScore >= 50) unlocked.add('forest');
            if (bestScore >= 75) unlocked.add('neon');

            return unlocked;
        }

        function countdown() {
            gameActive = false;
            let count = 3;
            const actionIcon = document.getElementById('actionIcon');
            const actionText = document.getElementById('actionText');
            const actionDisplay = document.querySelector('.action-display');
            
            actionIcon.style.display = 'none';
            actionText.classList.add('countdown');
            actionDisplay.style.background = 'radial-gradient(circle at top, #020617, #111827)';

            const interval = setInterval(() => {
                if (count > 0) {
                    actionText.textContent = count;
                    count--;
                } else {
                    clearInterval(interval);
                    actionText.classList.remove('countdown');
                    gameActive = true;
                    nextAction();
                }
            }, 600);
        }

        function nextAction() {
            if (!gameActive) return;
            
            resetGestureTracking();
            currentGesture = gestures[Math.floor(Math.random() * gestures.length)];
            
            const actionIcon = document.getElementById('actionIcon');
            const actionText = document.getElementById('actionText');
            const actionDisplay = document.querySelector('.action-display');
            
            actionIcon.textContent = currentGesture.icon;
            actionText.textContent = currentGesture.name;
            
            let bgColor;
            switch (currentGesture.type) {
                case 'shake':
                    bgColor = 'radial-gradient(circle at top, #7f1d1d, #450a0a)';
                    actionIcon.className = 'action-icon shake-animation';
                    break;
                case 'spin':
                    bgColor = 'radial-gradient(circle at top, #0f172a, #1e293b)';
                    actionIcon.className = 'action-icon spin-animation';
                    break;
                case 'tilt':
                    bgColor = 'radial-gradient(circle at top, #312e81, #1e3a8a)';
                    actionIcon.className = 'action-icon default-animation';
                    break;
                case 'fish':
                    bgColor = 'radial-gradient(circle at top, #064e3b, #022c22)';
                    actionIcon.className = 'action-icon default-animation';
                    break;
                case 'wave':
                    bgColor = 'radial-gradient(circle at top, #7c2d12, #431407)';
                    actionIcon.className = 'action-icon default-animation';
                    break;
                default:
                    bgColor = 'radial-gradient(circle at top, #1e293b, #020617)';
                    actionIcon.className = 'action-icon default-animation';
            }
            
            actionDisplay.style.background = bgColor;
            moveStartTime = Date.now();
            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            const timerFill = document.getElementById('timerFill');
            const startTime = Date.now();
            
            function updateTimer() {
                if (!gameActive || gamePaused) {
                    clearInterval(timerInterval);
                    return;
                }
                
                const elapsed = Date.now() - startTime;
                const remaining = Math.max(0, timeLimit - elapsed);
                const progress = (remaining / timeLimit) * 100;
                timerFill.style.width = progress + '%';
                
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 50);
        }

        function handleTutorialSuccess(gestureType) {
            const index = gestures.findIndex(g => g.type === gestureType);
            if (index !== -1) {
                gestureCompleted[index] = true;
                updateGestureStatus(index, '‚úÖ');
            }
        }

        function completeGesture() {
            if (!gameActive) return;

            const reactionTime = Date.now() - moveStartTime;
            moveTimes.push(reactionTime);
            moveHistory.push({
                gesture: currentGesture.name,
                type: currentGesture.type,
                time: reactionTime
            });

            score++;
            document.getElementById('currentScore').textContent = score;

            const feedback = document.createElement('div');
            feedback.className = 'success-feedback';
            feedback.textContent = '‚≠ê';
            document.body.appendChild(feedback);
            setTimeout(() => feedback.remove(), 500);

            if (score % 5 === 0 && timeLimit > 1000) {
                timeLimit -= 200;
            }
            
            nextAction();
        }

        function endGame() {
            gameActive = false;
            removeSensors();
            clearInterval(timerInterval);
            updateSummary();
            showScreen('summaryScreen');
        }

        function updateSummary() {
            const finalScore = document.getElementById('finalScore');
            finalScore.textContent = score.toString();

            if (moveTimes.length > 0) {
                const fastest = Math.min(...moveTimes);
                const slowest = Math.max(...moveTimes);
                document.getElementById('fastestMove').textContent = `${fastest} ms`;
                document.getElementById('slowestMove').textContent = `${slowest} ms`;
            } else {
                document.getElementById('fastestMove').textContent = '-';
                document.getElementById('slowestMove').textContent = '-';
            }

            const bestScore = getBestScore();
            if (score > bestScore) {
                showNewHighScorePrompt();
            } else {
                document.getElementById('newHighScoreSection').style.display = 'none';
            }

            displayHighScores();
        }

        function getBestScore() {
            const highScores = JSON.parse(localStorage.getItem('fidgetRushHighScores') || '[]');
            if (highScores.length === 0) return 0;
            return Math.max(...highScores.map(s => s.score));
        }

        function showNewHighScorePrompt() {
            document.getElementById('newHighScoreSection').style.display = 'block';
            const initialsInput = document.getElementById('initialsInput');
            if (initialsInput) {
                initialsInput.value = '';
                initialsInput.focus();
            }
        }

        function saveHighScore() {
            const initialsInput = document.getElementById('initialsInput');
            const initials = (initialsInput.value || '').toUpperCase().trim().slice(0, 3) || 'AAA';

            const newEntry = {
                initials,
                score,
                date: new Date().toISOString()
            };

            const highScores = JSON.parse(localStorage.getItem('fidgetRushHighScores') || '[]');
            highScores.push(newEntry);
            highScores.sort((a, b) => b.score - a.score);
            const truncated = highScores.slice(0, 10);
            localStorage.setItem('fidgetRushHighScores', JSON.stringify(truncated));

            document.getElementById('newHighScoreSection').style.display = 'none';
            displayHighScores();
        }

        function displayHighScores() {
            const container = document.getElementById('highScoreList');
            const highScores = JSON.parse(localStorage.getItem('fidgetRushHighScores') || '[]');
            const best = highScores.map(s => s.score)[0] || 0;
            
            container.innerHTML = '<h2>HIGH SCORES</h2>';

            if (highScores.length === 0) {
                const empty = document.createElement('div');
                empty.textContent = 'No scores yet. Play a game to set the first record!';
                empty.style.fontSize = 'clamp(0.8em, 2.5vw, 1em)';
                empty.style.marginTop = '5px';
                empty.style.opacity = '0.8';
                container.appendChild(empty);
                return;
            }

            highScores.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'highscore-item';
                if (index === 0) {
                    div.classList.add('first');
                }
                const date = new Date(entry.date);
                const dateStr = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                div.textContent = `${index + 1}. ${entry.initials} ‚Äî ${entry.score} pts (${dateStr})`;
                container.appendChild(div);
            });
        }

        function shareScore() {
            const text = `I just scored ${score} points in Fidget Rush! Can you beat me?`;
            if (navigator.share) {
                navigator.share({
                    title: 'Fidget Rush High Score',
                    text,
                    url: window.location.href
                }).catch(err => console.log('Share cancelled'));
            } else {
                alert('üì± Take a screenshot of this page to share your score on social media!');
            }
        }

        function restartGame() {
            showScreen('welcomeScreen');
        }

        loadTheme();
        displayHighScores();

        window.addEventListener('beforeunload', () => {
            removeSensors();
        });
    </script>

</body>
</html>
